### Hello Endpoint (Gin)
GET http://localhost:8080/hello
Accept: application/json

> {%
  client.test("Status code is 200", function() {
    client.assert(response.status === 200);
  });

  client.test("Response contains message", function() {
    client.assert(response.body.message === "Hello, World!");
  });
%}

### Metrics Endpoint - Prometheus Format (Gin)
GET http://localhost:8080/metrics
Accept: text/plain

> {%
  client.test("Status is 200 OK", function() {
    client.assert(response.status === 200);
  });

  client.test("Content-Type is Prometheus format", function() {
    client.assert(response.contentType.mimeType.includes("text/plain"));
  });

  client.test("Contains target_info metadata", function() {
    client.assert(response.body.includes("target_info"));
  });

  client.test("Contains service label", function() {
    client.assert(response.body.includes('service="gin-example"'));
  });

  client.test("Contains http_requests_total counter", function() {
    client.assert(response.body.includes("http_requests_total"));
  });

  client.test("Counter has required labels (method, path, status, duration_ms)", function() {
    client.assert(response.body.includes('method='));
    client.assert(response.body.includes('path='));
    client.assert(response.body.includes('status='));
    client.assert(response.body.includes('duration_ms='));
  });

  client.global.set("metrics_body", response.body);
%}

### Generate Traffic - Multiple Requests
GET http://localhost:8080/hello

> {%
  client.test("Hello endpoint responds", function() {
    client.assert(response.status === 200);
  });
%}

###
GET http://localhost:8080/hello

> {%
  client.test("Hello endpoint responds again", function() {
    client.assert(response.status === 200);
  });
%}

### Verify Metrics After Traffic - Counter Incremented
GET http://localhost:8080/metrics

> {%
  client.test("Metrics updated after requests", function() {
    const previousBody = client.global.get("metrics_body");
    client.assert(response.body !== previousBody, "Metrics should have updated");
  });

  client.test("Request counter increased", function() {
    const counterPattern = /http_requests_total\{[^}]*\}\s+(\d+)/g;
    const matches = response.body.match(counterPattern);
    client.assert(matches !== null && matches.length > 0, "Counter should have entries");
  });

  client.test("Hello endpoint metrics exist", function() {
    client.assert(response.body.includes('path="/hello"'), "Should track /hello endpoint");
  });

  client.test("Counters have service label", function() {
    const counterLines = response.body.split('\n').filter(line =>
      line.includes('http_requests_total') && !line.startsWith('#')
    );

    counterLines.forEach(line => {
      client.assert(line.includes('service="gin-example"'),
                   `Counter missing service label: ${line}`);
    });
  });
%}

### Final Validation - Prometheus Conventions
GET http://localhost:8080/metrics

> {%
  client.test("Counter follows Prometheus naming (ends with _total)", function() {
    client.assert(response.body.includes("http_requests_total"));
  });

  client.test("Metrics are properly formatted", function() {
    client.assert(response.body.includes("# HELP"));
    client.assert(response.body.includes("# TYPE"));
  });

  client.test("All metrics have proper labels", function() {
    const metricLinePattern = /^http_requests_total\{/;

    const metricLines = response.body.split('\n').filter(line =>
      line.match(metricLinePattern) && !line.startsWith('#')
    );

    client.assert(metricLines.length > 0, "Should have at least one metric line");

    metricLines.forEach(line => {
      client.assert(line.includes('method='), `Missing method label: ${line}`);
      client.assert(line.includes('path='), `Missing path label: ${line}`);
      client.assert(line.includes('status='), `Missing status label: ${line}`);
      client.assert(line.includes('duration_ms='), `Missing duration_ms label: ${line}`);
    });
  });
%}
